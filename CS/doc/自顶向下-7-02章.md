# 应用层

## 应用层协议原理

- 网络核心设备不在应用层上起作用，仅仅在较低层其作用，特别是网络层及其下面层次起作用。

### 网络应用程序体系结构

- 从应用程序研发者来看，网络体系结构是固定的，并且为应用程序提供了特定的服务集合。
- 应用程序体系结构应由应用程序研发者设计，规定了如何在各种端系统上组织该应用程序。

现代网络两种主体体系结构：客户 - 服务器体系结构 或 对等(P2P)体系结构

![CS&P2P](../image/CS_P2P.png)

在一个 P2P 体系结构 (P2P architecture)中,对位于数据中心的专用服务器有最小的(或者没有)依赖。相反,应用程序在间断连接的主机对之间使用直接通信,这些主机对被称为对等方。

-  许多目前流行的、流量密集型应用 都是 P2P 体系结构的 。比如 `BitTorrent`、对等方协助下载加速器（迅雷）、因特网电话和视频会议`Skype`。
-  某些应用会混合CS和P2P体系结构，比如很多即时讯息应用，服务器被用于追踪用户的`IP`地址,但是用户到用户的报文是主机之间直接发送的。
- P2P结构的自扩展性使得这种网络适用于各种规模和需求不断变化的应用场景，无需中心化的管理和控制，能够实现高度的分布式和去中心化特性。这种特性在文件共享、区块链、即时通信等领域中得到广泛应用。

### HTTP报文格式
`HTTP`请求报文第一行叫做`请求行`，后继的行叫做`首部行`。
请求行包含：方法字段、URL、HTTP版本字段。
![HTTP报文](../image/HTTP报文.png)
![请求](../image/HTTP请求报文.png)
```shell
➜  CS git:(main) ✗ telnet gaia.cs.umass.edu 80
Trying 128.119.245.12...
Connected to gaia.cs.umass.edu.
Escape character is '^]'.
HEAD /kurose_ross/interactive/index.php HTTP/1.1
Host: gaia.cs.umass.edu

HTTP/1.1 200 OK
Date: Mon, 20 Nov 2023 02:25:44 GMT
Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips PHP/7.4.33 mod_perl/2.0.11 Perl/v5.16.3
X-Powered-By: PHP/7.4.33
Set-Cookie: DevMode=0
Content-Type: text/html; charset=UTF-8

Connection closed by foreign host.
```

### 用户和服务器的交互：cookie（P 90）

作用：
- 限制用户访问
- 内容和用户关联
- 能够识别用户

组件：
- HTTP响应报文中的一个cookie首部行
- HTTP请求报文中的一个cookie首部行
- 用户端系统保留有一个cookie文件，并由用户浏览器管理
- 位于Web站点的一个后端数据库

![cookie](../image/cookie.png)

### Web缓存

Web 缓存器 (Web cache ) 也叫代理服务器 (proxy server)。

![无cache](../image/无cache.png)

- 其成本较低,很多缓存器使用了运行在廉价 PC 上的公共域软件 。

假设从因特网接入链公共因特网路一侧的路由器转发 HTTP 请求报文(在 一个 IP 数据报中)开始,到它收到其响应报文(通常在多个IP数据报中)为止的时间平均为2秒。

在局域网内，每秒钟有15个请求，每个请求的大小为1兆比特（Mb），并且局域网的带宽为100兆比特每秒（100Mbps）。所以，局域网上的通信强度可以用以下公式计算：

局域网通信强度 = （15请求/秒） x （1 Mb/请求） / 100 Mbps = 0.15

局域网上强度为0. 15的通信量通常最多导致数十毫秒 的时延,因此我们可以忽略局域网时延。

因特网路由器到机构路由器的链路上的流量强度。假设该强度为15个请求/秒，每个请求的大小为1兆比特（Mb），链路的带宽为15Mbps。所以，接入链路上的通信强度可以用以下公式计算：

接入链路通信强度 = （15请求/秒） x （1 Mb/请求） / 15 Mbps = 1

这表示在接入链路上，通信强度较高，可能导致更显著的时延。

![有cache](../image/有cache.png)

实践中的命中率(即由一个缓存器所满足的请求的比率)通常在 0.2~0.7 之间。这里假设命中率为0.4。因为用户和缓存连接在同一个相同高速局域网中，40%的请求被缓存其得到响应，时延约是10ms以内。60%请求接入链路，接入链路的流量强度从1.0减少到0.6。平均时延是：
 0.4 * (0.01秒) + 0.6 * (2.01)秒 约等于 1.2 秒

#### 条件GET方法
引入缓存器导致了缓存的数据可能已经被修改，HTTP协议有对应机制保证缓存器证实它的对象是最新的，这就是条件GET请求报文。

条件GET方法是一种在HTTP协议中使用的技术，旨在优化数据的传输效率并确保客户端所接收到的数据是最新的。这个过程涉及到缓存机制和服务器的交互。以下是条件GET请求的具体流程：

1. **客户端发送请求**：当客户端（如一个浏览器）请求一个资源（如网页或图片）时，它首先检查本地缓存中是否已经有这个资源的副本。

2. **检查缓存有效性**：如果资源存在于缓存中，客户端将检查它的有效性。这通常通过资源的元数据来完成，如“最后修改时间”或一个特定的实体标签（ETag）。

3. **构建条件GET请求**：如果缓存的资源可能已经过时，客户端将发送一个条件GET请求到服务器。这个请求包含了诸如`If-Modified-Since`或`If-None-Match`的头部，这些头部携带了资源的最后修改时间或ETag值。

4. **服务器处理请求**：服务器接收到条件GET请求后，会检查请求头中的信息。服务器将比较这些数据与当前资源的实际最后修改时间或ETag。

5. **资源状态判断**：
   - **未修改（304 Not Modified）**：如果资源自客户端上次请求以来未发生变化（即缓存的副本是最新的），服务器将返回一个304状态码，表示“未修改”。在这种情况下，客户端可以安全地使用其缓存副本。
   - **已修改（200 OK）**：如果资源已被修改，服务器将发送一个200状态码，连同资源的最新版本。客户端接收到这后，将更新其缓存。

6. **更新客户端缓存**：客户端根据服务器的响应更新其本地缓存。如果资源已更新，客户端将替换缓存中的旧副本；如果资源未更新，则继续使用缓存中的副本。

条件GET方法的优势在于减少不必要的数据传输，因为只有在资源实际发生变化时才会下载新内容，从而节约带宽并提高效率。同时，它也确保客户端总是显示或处理的是最新的数据。
![myCache](../image/MyChromeCache.png)

#### SMTP

- SMTP一般不使用中间邮件服务器发送邮件，即使隔了半个地球。
- 如果接收邮件服务器没有开机，该报文会保留在发送的邮件服务器上，并等待进行新的尝试。

发送流程:
1. 客户`SMTP`（运行在接收邮件服务器主机上）在25号端口建立一个到服务器`SMTP`（运行在接收邮件服务器主机）的TCP连接。如果服务器每开机，客户会在稍后继续尝试连接。
2. 服务器和客户执行某些应用层的握手，`SMTP`客户指示发送方的邮件地址和接收方的邮件地址。
3. 握手完后证实发送报文。
4. 如果客户有另外的报文要发送到该服务器，重复上述步骤直至关闭连接

其他类似实现`POP3`、`IMAP`协议，比`SMTP`复杂得多，自己配了个`SMTP`协议的命令行发送邮箱就跳了。

#### DNS

0. DNS也有缓存
1. 一个由分层的`DNS服务器`实现的分布式数据库。
2. 一个使得主机能够查询分布式数据库的**应用层协议**。
   应用层协议的原因：
   - 使用客户 - 服务器模式运行在通信的端系统之间。
   - 在通信的端系统之间通过下面的端到端运输协议来传送DNS报文。
3. 运行在`UDP`之上，使用53号端口。
4. 将主机名转换成其背后的IP地址。
5. DNS获取IP地址会有额外的时延，想获得的IP地址通常缓存在一个“附近的”DNS服务器，一般时间不会太久。

用户主机能够将一个HTTP请求报文发送到Web服务器www.someschool.edu，用户主机必须获得其IP地址，做法：
1. 同一台用户主机上运行着`DNS`应用的客户端
2. 浏览器从上述URL中抽取主机名`www.someschool.edu`，并且将主机名传给DNS应用的客户端
3. DNS用户向DNS服务器发送一个包含主机名的请求
4. DNS用户最终会受到一份回答报文，其中包含对应于该主机名的IP地址
5. 一旦浏览器接收到DNS的ip地址，它就能向该IP地址的80端口的HTTP服务器进程发起一个TCP连接。

DNS提供的服务：
1. 主机别名。
2. 邮件服务器别名。
3. 负载分配。DNS也用在冗余的服务器(如冗余的 Web 服务器等)之间进行负载分配 。 繁忙的站点(如 cnn. com) 被冗余分布在多台服务器上 ,每台服务器均运行在不同的端系统上,每个都有着不同的 IP 地址。由千这些冗余的 Web 服务器, 一个IP地址集合因此与同一个规范主机名相联系。

DNS服务器呈现层次方式组织，分布全世界范围内，没有一台服务器有因特网上所有主机的映射。

DNS服务器大致有3类：根DNS服务器、顶级域DNS服务器、权威DNS服务器。
![部分DNS服务器](../image/部分DNS服务器的层次结构.png)
假定一个DNS客户要决定主机名`www.amazon.com`的IP地址。粗略会发生下面的内容（P87）:
1. 与根服务器之一联系，它返回顶级域名com的TLD服务器的IP地址
2. 与TLD服务器联系，将为`amazon.com`返回权威服务器的IP地址
3. 客户和`amazon.com`权威服务器之一联系，为主机名`www.amazon.com`返回其IP地址。

假设主机`cse.nyu.edu`想知道主机`gaia.cs.umass.edu`的IP地址。
![部分DNS服务器交互](../image/DNS服务器交互.png)
共发送了 8 份 DNS 报文: 4 份查询报文和 4 份回答报文。

从cse.nyu.edu到dns.nyu.edu发出的查询是递归查询,因为该查询以自己的名义请求dns.nyu.edu来获得该映射。而后继的3个查询是迭代查询,因为所有的回答都是直接返回给dns.nyu.edu。

任何 DNS根DNS服务器查询既可以是迭代的也能是递归的。
![DNS服务器递归查询](../image/DNS服务器递归查询.png)

递归查询和迭代查询，它们之间有一些重要的区别和各自的优缺点。

1. 递归查询（Recursive Query）：
   - 客户端发起查询请求，通常是用户设备上的浏览器或操作系统。
   - DNS服务器接收到请求后，负责完全解析请求，从根域名服务器开始逐级查询，直到找到与域名对应的IP地址或者查询失败。
   - DNS服务器将查询结果返回给客户端，客户端不需要执行额外的查询工作。

   优点：
   - 对于客户端来说，递归查询是一种简单的方式，它只需要向DNS服务器发送一个请求，然后等待响应。
   - 客户端无需了解DNS层次结构的细节，这种查询模式对于非技术用户友好。

   缺点：
   - 对DNS服务器来说，递归查询需要更多的资源和处理能力，因为它需要负责处理整个查询过程。
   - 递归查询可能会使DNS服务器容易受到DNS放大攻击的影响，因为攻击者可以伪造查询请求，使服务器执行大量递归查询。

2. 迭代查询（Iterative Query）：
   - 客户端发起查询请求，但DNS服务器不会为客户端执行完整的查询。相反，DNS服务器会向客户端提供下一个需要查询的DNS服务器的IP地址。
   - 客户端将进一步的查询请求发送给下一个DNS服务器，然后依次迭代查询，直到找到与域名对应的IP地址或者查询失败。

   优点：
   - 迭代查询将查询负担分散到多个DNS服务器上，减轻了单个DNS服务器的负担。
   - 较少容易受到DNS放大攻击的威胁，因为每个DNS服务器只需要处理一个小部分的查询请求。

   缺点：
   - 对于客户端来说，迭代查询需要更多的步骤，因为它需要多次向不同的DNS服务器发送查询请求。
   - 客户端需要处理更多的细节，包括确定下一个要查询的DNS服务器，并在每一步中发送请求。

总的来说，递归查询更加简单和方便，适用于普通用户和大多数网络环境。迭代查询分散了负担，更适用于DNS服务器之间的查询交互，有助于提高DNS系统的可扩展性和安全性。选择适当的查询方式取决于特定的使用情境和需求。通常情况下，客户端使用递归查询，而DNS服务器之间使用迭代查询来解析域名。

#### DNS记录和报文

共同实现DNS分布式数据库的所有DNS服务器存储了**资源记录(RR)**，其提供了主机名到IP 地址的映射。
RR是一个四元组：(Name , Value , Type , TTL) TTL是记录的生存时间，决定该何时从缓存中删除的时间。
![报文格式](../image/DNS报文格式.png)

##### DNS的健壮性
![DNS](../image/DNS.png)

- 对流式视频最为重要的性能度量是平均端到端吞吐量。为了提供连续不断的布局，网络必须为流式应用提供平均吞吐量，这个流式应用至少比压缩视频的比特一样大。
- 压缩也可以有不同的质量等级，比如比特率为:`300kbps`、 `1Mbps`、`3Mbps`。
- 分布式散列表(DHT)也是p2p的思想
- DASH(Dynamic Adaptive Streaming over HTTP)是一种流媒体传输协议。它是一种用于以自适应方式传输音频和视频内容的协议，通常通过HTTP协议进行数据传输。
DASH的主要特点包括：

1. **自适应性**：DASH允许根据网络条件和终端设备的性能来自动调整音频和视频的质量。这意味着在不同的网络带宽和设备性能下，DASH可以提供最佳的观看体验，以避免缓冲和播放中断。

2. **分段化**：DASH将音频和视频内容划分为一系列小的分段或块。每个分段通常包含短暂的媒体数据，这些分段通过HTTP请求进行传输。这种分段化的方法有助于提高流媒体传输的灵活性和效率。

3. **多码率支持**：DASH通常提供多个不同比特率（质量）的音频和视频流作为备选。根据当前的网络条件，客户端可以选择合适的码率进行播放。

4. **多媒体类型支持**：DASH不仅支持视频流，还可以用于传输音频和其他媒体类型，使其适用于多种多媒体应用。

5. **广泛的设备支持**：由于DASH使用HTTP协议，因此可以在各种终端设备上使用，包括计算机、智能手机、平板电脑、智能电视等。

虽然DASH是一种流媒体传输协议，但它通常与各种编解码器（如H.264、H.265、VP9等）和媒体封装格式（如MP4、WebM等）一起使用，以实现实际的音视频内容传输。与DASH类似的其他流媒体协议包括HLS（HTTP Live Streaming）和Smooth Streaming等，它们都旨在提供高质量的流媒体传输体验。

由于因特网视频的发展，有巨量的视频需要传输，如果建立单一的大规模数据中心，会出现三个问题：
  1. 客户远离数据中心。之间的链路之一提供的吞吐量小于视频消耗速率，这就会有大量时延。
  2. 浪费网络带宽，大量发送相同视频，需要给ISP支付更多费用
  3. 数据中心崩溃

解决方案：
几乎所有的视频流公司都采用`内容分发网络(Content Distribution Network)`。`CDN`管理分布多个地理位置的服务器上，存储视频的副本。其是由多个服务器和网络节点组成的分布式系统。
CDN分为：集中式CDN和分布式CDN。

1. **内容缓存和复制**：CDN提供商会在全球范围内部署多个服务器和缓存节点，这些节点存储了网站或应用程序的静态资源的副本，例如HTML页面、图像、CSS、JavaScript文件等。这些资源会根据需求被缓存和复制到CDN节点上。

2. **就近性**：CDN节点通常分布在不同的地理位置，因此用户可以从距离最近的CDN节点获取所需的内容，从而减少了网络延迟和数据传输时间。

3. **负载均衡**：CDN可以根据网络流量和服务器负载来智能地分发请求，以确保内容始终能够快速响应，即使在高流量时期也是如此。

4. **内容压缩**：CDN可以对传输的内容进行压缩，减少带宽使用，从而提高传输速度。

5. **安全性**：CDN通常提供一定程度的安全性，可以帮助防御DDoS攻击和其他网络威胁，保护网站和应用程序免受恶意访问。

6. **内容更新和刷新**：CDN可以快速更新或刷新缓存中的内容，以确保用户始终看到最新版本的网站或应用程序。

#### 覆盖网路
覆盖网络（Overlay Network）是一个在底层网络结构之上构建的网络，通常由多个节点或计算机组成，这些节点通过逻辑连接（而不是物理连接）相互通信。覆盖网络允许在现有的底层网络基础上创建新的网络拓扑，以满足特定需求或提供特定服务。覆盖网络通常由应用程序或服务提供者管理和维护。

覆盖网络的主要特点包括：

1. 逻辑连接：覆盖网络中的节点之间通常通过逻辑连接相互连接，这些连接可以通过底层网络进行路由，但不是物理直接连接。

2. 独立性：覆盖网络是相对独立于底层网络的，它可以使用不同的通信协议、拓扑结构和路由策略，以满足特定的需求。因此，不同的覆盖网络可以共存于相同的底层网络之上。

3. 功能扩展：覆盖网络可以扩展或增强底层网络的功能。例如，它可以提供更高级的安全性、负载均衡、内容分发、流量优化等服务。

4. 应用领域：覆盖网络在多个领域中都有应用，包括点对点文件共享、内容分发网络（CDN）、虚拟专用网络（VPN）、区块链网络等。

在覆盖网络中，边通常指的是连接两个节点的逻辑连接或通信链路。这些边可能是点对点连接，也可能是多对多连接，具体取决于覆盖网络的拓扑结构和设计。边上的数据传输可以采用不同的协议和通信方式，根据网络的需求进行优化。

覆盖网络可以包括路由功能，但它通常不涉及物理路由器或交换机。相反，覆盖网络中的路由是基于逻辑连接和节点之间的通信需求来管理的。这些路由决策可能是集中式的，由覆盖网络的管理者控制，也可能是分散式的，由节点之间相互协商来决定最佳路由路径。覆盖网络的路由策略通常不同于底层网络的路由策略，因为它们服务于不同的目标和需求。
# 复习题

## 列出五种非专用的因特网应用以及它们所使用的应用层协议

- 邮箱(SMTP、POP3、IMAP)
- 文件传输(FTP、SSH)
- 网页(HTTP)
- sftp webdav ssh smb(win文件共享)
- 打印机（Samba）
- 文件共享(分布式BitTorrent)
- 远程访问和控制计算机桌面（RDP、VNC）

## 网络体系结构与应用程序体系结构之间的区别是什么

从开发者角度看，网络体系结构是固定的，而应用体系结构相对来说比较灵活，由应用开发者规定了如何在各种端系统上组织该应用程序。
网络体系结构通常涉及多层次的结构，如 OSI（Open Systems Interconnection）模型或 TCP/IP 模型，这些模型定义了网络中的不同层次和协议。
应用程序体系结构通常包括客户端-服务器模型、分布式体系结构、单层体系结构等，根据应用程序的需求和架构决策而变化。
网络体系结构的实施涉及网络设备、路由器、交换机、防火墙、协议栈等技术。
应用程序体系结构的实施涉及编程语言、框架、数据库系统、用户界面设计等技术。

## 运行在一台主机上的一个进程，使用什么信息来标识运行在另一台主机上的进程

需要定义两种信息，主机地址和定义在目的主机中接收进程的标识符，在网络中，主机地址由IP地址标识，而目的主机由端口号来定义。

## 假定你想尽快地处理从远程客户到服务器的事务,你将使用 UDP 还是 TCP ? 为什么?

UDP。快，不需要握手。

##  前面讲过 TCP 能用 SSL 来强化,以提供进程到进程的安全性服务,包括加密。SSL运行在运输层还是应用层?如果某应用程序研制者想要用 SSL 来强化 UDP, 该研制者应当做些什么工作 ?

应用层和传输层之间。DTLS协议。

## cookie保存每一个客户的购买记录

对于购买记录的保留，一种常见的做法是使用Cookie。Cookie是存储在客户端浏览器中的小型文本文件，可以包含有关用户的信息。以下是描述如何使用Cookie来实现保留每个客户的购买记录的功能：

1. 在用户进行购买时，服务器会生成一个唯一的标识符（例如，一个UUID或用户ID），并将该标识符存储在Cookie中。

2. 服务器还会将购买记录存储在数据库或服务器端的存储系统中，同时与生成的标识符相关联。

3. 每当用户进行购买或查看购买记录时，客户端会将存储在Cookie中的标识符发送回服务器。

4. 服务器使用收到的标识符来检索特定用户的购买记录，并向客户端返回相关信息。

5. 客户端可以将收到的购买记录显示给用户。

## Web缓存其是如何减少接收被请求对象的时延的，Web缓存器将减少一个用户请求的所有对象还是只是其中的某些对象的时延？
Web缓存器是一种用于存储和提供已请求对象的中间服务器，目的是减少网络流量、提高性能并降低服务器负载。
1. 当客户端请求一个对象（如网页、图片或脚本）时，首先检查本地缓存是否已经有了这个对象的副本。

2. 如果缓存中存在请求的对象，并且该对象仍然有效（未过期），则缓存会立即返回该对象给客户端，而不需要向原始服务器发出请求。这减少了时延，因为从缓存获取对象比通过网络请求更快。

3. 如果缓存中没有请求的对象，或者对象已经过期，缓存器会向原始服务器发出请求以获取最新的对象。然后，它将新的对象存储在缓存中，并返回给客户端。

4. Web缓存器通常会缓存频繁请求的对象，以便提供更快的响应时间。

因此，Web缓存器主要减少了一部分对象的时延，即那些已经缓存在缓存器中或经常被请求的对象。对于那些不在缓存中且不经常被请求的对象，时延仍然取决于原始服务器的响应时间。因此，Web缓存器可以显著减少网络流量和提高性能，但它不会减少每个用户请求的所有对象的时延。