# 计算机网络和因特网

## 1.1 什么是因特网

回答这个问题有两种方式 : 
- 我们能够描述因特网的具体构成,即构成因特网的基本硬件和软件组件;
- 我们能够根据为分布式应用提供服务的联网基础设施来描述因特网。

### 具体构成描述

- 因特网是一个世界范围的计算机网络,即它是一个互联了遍及全世界数十亿计算设备的网络。
- 用因特网术语来说,这些连接到因特网的所有这些设备（手表、汽车、家用电器等等）都称为主机 ( host ) 或端系统 (end system)。
- 端系统通过通信链路 (communication link) 和分组交换机 ( packet switch ) 连接到一起。
- 当一台端系统要向另一台端系统发送数据时,发送端系统将数据分段,并为每段加上首部字节。由此形成的信息包用计算机网络的术语来说称为 **分组** (packet)。
-  链路层交换机通常用于接入网中,而路由器通常用于网络核心中。从发送端系统到接收端系统,一个分组所经历的一系列通信链路和分组交换机称为通过该网络的 路径 (route或path) 。

### 什么是协议

![人类协议和计算机网络协议](../image/协议.png)

**协议**(protocol)定义了在两个或多个通信实体之间交换的报文的格式和顺序,以及报文发送或接收一条报文或其他事件所采取的动作。

## 1.2 网络边缘

主机=端系统 。 主机有时又被进一步划分为两类 :客户(client) 和服务器 (server) 。 客户通常是桌面 PC 、移动 PC 和智能手机等,而服务器通常是更为强大的机器,用于存储和发布 Web 页面、流视频、中继电子邮件等 。

   - 网络边缘指的是计算机网络的边缘部分，通常位于网络的最外围。它包括终端设备，如个人电脑、智能手机、平板电脑、服务器以及其他连接到网络的设备。
   
   - 在网络边缘，数据通常进入或离开网络，因此这里通常发生数据交换。终端设备通过接入网络来访问各种网络服务和资源，如互联网、局域网（LAN）、广域网（WAN）、云服务等。

   - 用户通过网络边缘与网络互动，发送和接收数据，访问在线应用程序、网站和服务。网络边缘设备通常通过各种通信技术（例如以太网、Wi-Fi、蜂窝数据、光纤等）连接到网络。

### 接入网

   - 接入网是计算机网络的一部分，通常位于网络的边缘，连接到网络边缘设备，提供连接终端设备到核心网络的通信通道。

   - 接入网通常包括各种网络设备和技术，用于将用户终端设备连接到更大范围的网络，例如互联网或企业内部网络。

   - 不同类型的接入网技术包括有线接入（如以太网、DSL、电缆）、无线接入（如Wi-Fi、蜂窝数据网络）、光纤接入等。这些技术用于提供不同速度和性能的网络连接，以满足不同用户和应用的需求。

## 1.3 网络核心

概念： 由互联因特网端系统的分组交换机和链路构成网状网络。

### 分组交换

- 网络应用中，端系统互相交换**报文**，源将长报文划分成较小的数据块成为**分组**，分组以等于该链路最大传输速率的速度传输通过通信链路。
- 每个分组都需要通过通信链路和分组交换机传送（交换机主要分两类：路由器和链路层交换机）。

#### 存储转发传输

- 多数分组交换机在链路的输入端使用**存储转发传输机制**。该机制是指交换机能够向输出链路传输该分组的第一个比特之前，必须接收到整个分组。
- 如果只接收部分就必须缓存该分组的比特。

假设传输正常且忽略时间延迟，源在时刻 0 开始传输,速率均为 R，在时刻 `L/R` 秒,因为该路由器刚好接收到整个分组,所以它能够朝着目的地向出链路开始传输分组;在时刻 `2L/R` , 路由器已经传输了整个分组,并且整个分组已经被目 的地接收 。 所以,总时延是 `2L/R` 。如果比特到达就转发而不是等待全部接收，总时延就是`L/R`。假设传输的是三个分组，且使用存储转发传输，总时延是`4L/R`，交换机在接收分组2的同时发送分组1。

#### 排队时延和分组丢失

- 每个分组交换机跟多条链路相连，对于每条链路，该分组交换机具有一个**输出缓存**（输出队列）。因此除了上面的存储转发造成的时延，还需要承受输出缓存的**排队时延**。这取决与网络的拥塞程度。
- 如果到达的分组发现输出缓存已经被其他链路占满了。此时该分组就是被丢弃，这就是**丢包**。

#### 转发表和路由选择协议

- 不同的计算机网络实现分组转发的方式是不同的。
- 每台路巾器具有一个转发表(forwarding table)，用于将目的地址(或目的地址的一部分)映射成为输出链路当某分组到达一台路由器时，路由器检查该地址，并用这个目的地址搜索其转发表，以发现适当的出链路。路由器则将分组导向该出链路。
- 因特网有一些具有特殊的路由选择协议用来设置转发表。

### 电路交换

通过网络链路和交换机移动数据有两种基本方法：电路交换和分组交换。
- 电路交换网络中在通信会话期间，预留了端系统间沿路径通信需要的资源（缓存，链路传输速率），确保发送方能以确保的恒定速率向接收方传送数据。

#### 电路交换的复用

- 链路中的电路是通过`频分复用`（FDM）或者`时分复用`(TDM)来实现的。
频分复用：
   - 在连接期间链路为每个连接专用一个频段。eg:电话网络中这个频段一般是 4k HZ（每秒4000周期）。该频段的宽度就叫做**带宽**。
时分复用：
   - 时间被划分为固定期间的帧，每个帧被划分为固定数量的时隙。当网络跨越一条链路创建连接时，网络在每个帧中为该连接指定一个时隙。
   - 时隙专门由该连接单独使用，可用于传输数据。
![TDM&FDM](../image/FDM_TDM.png)

##### 例子

当考虑从主机 A 到主机 B 经过一个电路交换网络发送一个 640,000 比特的文件时，我们需要计算传输所需的时间。假设在该网络中，所有链路都使用具有 24 时隙的时分多路复用（TDM），比特速率为 1.536 Mbps。同时，假定在主机 A 能够开始传输文件之前需要 500 毫秒来建立一条端到端的电路。

首先，计算每条链路的传输速率是 1.536 Mbps / 24 = 64 kbps。

接下来，计算传输整个文件所需的时间：
文件大小为 640,000 比特，传输速率为 64 kbps，因此传输文件需要的时间是（640,000 比特）/（64 kbps）= 10 秒。

然而，还需要考虑电路建立时间，这需要额外的 500 毫秒（0.5 秒）。

因此，传输文件的总时间是 10 秒（传输时间） + 0.5 秒（电路建立时间），即 10.5 秒。

总结起来，传输文件需要 10.5 秒的时间，不论是通过一条链路还是多条链路，传输时间都是一样的，因为电路建立时间不受链路数量的影响。

### 分组交换和电路交换的对比
分组交换：
- 不适合实时服务（电话，视频），因为会受到网络波动影响。
- 提供了比电路交换更好的带宽共享
- 比电路交换简单、有效、实现成本低
- 分组交换的性能能够优于电路交换的性能
电路交换：
- 电路交换不够经济。因为电路交换处于静默期时，空闲资源不能被其他人使用。
- 避免因为网络原因造成的服务不稳定
- 实现比较复杂

#### 例子

假设多个用户共享一条 `1Mbps` 的链路，再假设用户活跃周期性变化，某用户时而以`100kbps`的速率发送数据，时而什么都不干。假设用户都是有10%的时间会发送数据，其他90%的时间什么都不干。

对于电路交换，在所有的时间内必须为每个用户预留`100kbps`。例如`TDM`，如果1s的帧被划分为10个时隙，每个时隙100ms,则每帧将为每个用户分配一个时隙。因此很简单得出，该电路交换链路仅支持10个并发用户。

对于分组交换，假如有35个用户，有11个或者更多个并发的活跃用户的概率是0.0004,有10个或者更少用户的概率是0.9996,，且到达的聚合数据速率小于等于`1Mbps`,基本没有时延迟。用户超过十个，聚合数据速率大于`1Mbps`，输出队列开始变长（直至用户少于10）。由于概率极小，分组交换差不多提供了与电路交换相同的性能。

还是上面的假设，10个用户，某个用户突然产生1000个1000比特的分组，其他用户什么都不干。如果是`TDM`，每次只有一个时隙被使用，传送完数据需要10s。而如果是分组交换，只需要1s就能发送完毕。

### 网络的网络

端系统经过接入一个ISP与因特网相连。该接入的ISP为其提供有线/无线连接，因为ISP不是唯一的，接入ISP自身必须互联。通过创建网络的网络可以做到这一点。随着网络的不断发展，构成因特网的“网络的网络”已经演化成一个十分复杂的结构，这更多是因为为了经济和政治导致的，而不是性能。
1. 网络结构1
互联接入ISP的中心目标是为了使得所有的端系统彼此能够发送分组。一个很简单的思路就是使每个接入ISP直接与其他接入ISP连接。这样的网状设计对于接入ISP的费用太高，因为这要求每个接入的ISP要与世界上现存的所有ISP有一条单独的通信链路。此时接入ISP被认为是客户，而全球传输ISP被认为是提供商。
2. 网络结构2
在刚才思路的基础上：有多个公司建立自己的全球ISP传输并且与其他进行竞争。接入ISP就能在它们之间选择了，但是需要注意的是，这些全球的ISP必须互联，否则不能和其他全球传输的ISP进行通信。
3. 网络结构3
在任何特定的区域上都可能有一个区域ISP,每个区域ISP和第一层的ISP（类似于刚刚假设的全球ISP）连接。区域ISP为下面的客户提供服务，如果需要和全球的ISP交互就将其发送给上一层。当然了区域ISP也是有竞争的，不可能只有一个。比如在中国，每个城市有接入ISP，与省级ISP连接，省级ISP与国家级ISP连接，国家级ISP最终与第一层ISP连接。
4. 网络结构4
为了更加实用，在`网络结构3`的基础上添加了存在点、多宿、对等和因特交换点。
- 存在点（PoP）：通常是指网络中的一个节点或者位置
   - **状态指示**：显示用户或设备是否在线、忙碌、离线等状态。
   - **资源定位**：帮助确定用户或资源当前所在的网络位置。
   - **通讯协调**：协助建立和管理网络通讯连接，例如启动聊天或视频会议。
- 多宿：一种网络配置，其中一个网络实体（如计算机、路由器、或整个网络）通过多条不同的路径连接到互联网。这种配置增强了网络的可靠性、冗余性和可能的性能。
- 对等：相同等级结构层次的邻近一对ISP能够对等，能够直接它们的网络连接在一起且任一个ISP不向其对等收费
- 因特交换点（IXP）：它是一个物理基础设施，通过该基础设施，不同的互联网服务提供商（ISP）和其他网络可以交换互联网流量。IXP的主要目的是通过直接的、区域性的路由，减少数据在互联网上的旅程，从而提高效率和降低成本。
5. 网络结构5
其在4的基础上添加了`内容提供商网络`。比如谷歌，谷歌数据中心都经过专用的 TCP/IP 网络互联,该网络跨越全球,不过独立于公共因特网。谷歌专用网络通过与较低层ISP 对等(无结算),尝试绕过“因特网的较高层,采用的方式可以是直接与它们连接,或者在 IXP 处与它们连接[Labovitz 2010]。然而，因为许多接人 ISP 仍然仅能通过第一层网络的传输到达, 所以谷歌网络也与第一层ISP连接,并就与这些 TSP 交换的流量向它们付费。通过创建自己的网络、内容提供商不仅**减少了向顶层 ISP 支付的费用**，而且对**其服务最终如何交付给端用户有了更多的控制**。

![ISP](../image/ISP互联.png)

## 1.4 分组交换网中的时延、丢包和吞吐量

我们希望因特网服务能够在任意两个端系统之间随心所欲地瞬间移动数据且无任何数据丢失，这是一个极高的目标，实践很难达到。与之相反，计算机网络必须要限制端系统的吞吐量，在端系统引入时延，而且实际上也会丢失分组。

### 分组交换网的时延概述

分组从一台主机出发通过一系列路由器传输，在另一台主机中结束它的历程。当分组从一个节点（主机/路由器）沿着这条路径到候机节点，该分组在沿途每个节点都会经受几种不同类型的延迟：节点处理延迟、排队时延、传输时延和传播时延，这些时延加起来就是**节点总时延**。

#### 时延类型

![时延类型](../image/时延类型.png)

1. 处理时延

检查分组头部和决定该分组导向何处需要的时间是处理时延的一部分，还有检查比特级别的差错所需要的时间等等。

2. 排队时延

前面说过了就不重复了。

3. 传输时延

假设分组是先到先服务，仅当所有已经到达的分组被传输后才能传输刚到达的分组。**传输时延**指将所有数据比特从发送端传输到通信链路上所需要的时间。它取决于数据的大小和链路的传输速率。

4. 传播时延

传播时延是数据在链路中传播一定距离所需要的时间。它取决于链路的长度和信号在链路中的传播速度（通常接近光速）。

- 这里需要特别注意传播时延和传输时延的区别。
[交互式体验](https://media.pearsoncmg.com/aw/ecs_kurose_compnetwork_7/cw/content/interactiveanimations/transmission-vs-propogation-delay/transmission-propagation-delay-ch1/index.html)

### 排队时延和丢包
令a表示分组到达队列的平均速率（单位是分组/秒）;R是传输速率，即从队列中推出比特的速率（单位是b/s）;所有的分组都是L比特组成。
- 比率`La/R`被称为流量强度。`La/R` > 1 则表示比特到达队列的平均速率超过从该队列传输出去的速率。这种情况持续就会导致丢包。
- 因此流量工程中设计系统时流量强度不能大于1。
- 更为真实的情况下，`La/R` 通常不足 全面地表示时延的统计量。因为分组之间的时间间隔是随机的。
- 随着流量强度接近1，平均排队时延迅速增加。该强度的少量增加就会导致时延大比例增加。

#### 丢包

- 一条链路的队列容量有限，到达的分组如果发现队列已经满了，由于没有地方存储这个队列，路由器就会**丢弃**该分组。
- 从端系统来看，分组发送给了网路核心，但是不会从网络发送到目的地。
[交互式体验](https://media.pearsoncmg.com/aw/ecs_kurose_compnetwork_7/cw/content/interactiveanimations/queuing-loss-applet/index.html)

### 端到端时延

前面讨论的是一个节点的延迟，现在我们考虑从源到目的地的总时延。
总时延是每个节点的时延之和加上总传播时延。

![traceroute](../image/trace_1.png)

### 计算机网络中的吞吐量

计算机网络中另一个至关重要的性能测度是端到端吞吐量。 在任何时间瞬间的**瞬时吞吐量**是主机B接收到文件的速率（bps）。如果文件是 F 比特用去了 t 秒，`F/t`就是**平均吞吐量**。

![吞吐量](../image/吞吐量.png)

假设一个文件从服务器传输给用户，该文件传输的吞吐量实际上是`min{R1,R2,R3..Rn}`，如果超过最小的R就会导致丢包问题。

那如果有10台服务器和10个用户与计算机网络核心相连且用的是同一条链路，这10台服务器分别只和一个用户连接。

！[多服务器多用户](../image/多服务器多用户.png)
RS是服务器接入该链路的速率
RC是用户接入该链路的速率

如果这个链路的容量 R >> `10min(RS,RC)`，那么和上面第一种情况一样，如果处于一个数量级的话，就只能将R平均分给这10个服务器，它们就不能全速传输了。
